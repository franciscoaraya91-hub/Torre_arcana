<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Torre Arcana ‚Äî v1.13.5 FULL (seed forzado + todo)</title>
<style>
:root{
  --bg:#0f1226;--panel:#171a33;--soft:#1e2242;
  --accent:#7aa8ff;--accent2:#9bffb1;--txt:#e6e9ff;--muted:#9aa3c7;
  --danger:#ff6b6b;--gold:#ffd66b;--gem:#94f1ff;
}
*{box-sizing:border-box}
body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,#1b1f3f 0%,var(--bg) 50%,#0b0d1a 100%);color:var(--txt);font-family:system-ui,Segoe UI,Roboto;line-height:1.35}
header{padding:14px 16px;background:linear-gradient(180deg,rgba(122,168,255,.10),rgba(122,168,255,0)),var(--panel);border-bottom:1px solid #22284b;position:sticky;top:0;z-index:5;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
header h1{font-size:18px;margin:0}.pill{padding:6px 10px;background:var(--soft);border:1px solid #252a53;border-radius:999px;font-size:12px;color:var(--muted)}
#root{display:grid;grid-template-columns:480px 1fr 600px;gap:14px;padding:14px;max-width:2300px;margin:0 auto}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)),var(--panel);border:1px solid #22284b;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
.card h2{font-size:14px;margin:0;padding:10px 12px;background:var(--soft);color:var(--muted);border-bottom:1px solid #22284b}
.section{padding:12px}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.col{display:flex;flex-direction:column;gap:8px}
button{background:linear-gradient(180deg,rgba(122,168,255,.20),rgba(122,168,255,0));color:var(--txt);border:1px solid #2b3163;padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600}
button:hover{transform:translateY(-1px)}button:disabled{opacity:.5;cursor:not-allowed}
.btn-accent{background:linear-gradient(180deg,rgba(155,255,177,.25),rgba(155,255,177,0));border-color:#2a5a3f}
.btn-danger{background:linear-gradient(180deg,rgba(255,107,107,.25),rgba(255,107,107,0));border-color:#6b2a2a}
.btn-gold{background:linear-gradient(180deg,rgba(255,214,107,.28),rgba(255,214,107,0));border-color:#6b5a2a;color:#fff8d8}
.btn-red{background:linear-gradient(180deg,rgba(255,107,107,.35),rgba(255,107,107,0));border-color:#8b3b3b}
.money{color:var(--gold);font-weight:700}.gems{color:var(--gem);font-weight:700}
#log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;max-height:200px;overflow:auto;white-space:pre-line}
.hero-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.hero-card{border:1px solid #2b3163;border-radius:12px;padding:8px;background:#121538;cursor:pointer}
.hero-card.selected{outline:2px solid var(--accent)}.star{color:#ffd66b}
.party{display:flex;gap:8px;flex-wrap:wrap}.party-slot{border:1px dashed #394074;border-radius:12px;padding:6px 8px;min-width:120px;min-height:44px}
.badge{background:#19204d;border:1px solid #2b3163;border-radius:10px;padding:2px 6px;font-size:11px;color:#9aa3c7}
.hud{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.unit{border:1px solid #2b3163;border-radius:12px;padding:8px;background:#11143a}
.unit h3{margin:0 0 6px 0;font-size:14px;color:#bcd3ff}
.urow{display:flex;gap:8px;justify-content:space-between;font-size:12px;color:#a7b0d8}
.hpwrap{height:14px}.hpbar{height:100%;background:linear-gradient(90deg,#5aff88,#afffc7);width:100%}
.ehpbar{height:14px;background:linear-gradient(90deg,#ff8f8f,#ffd0d0);width:100%}
.enemy-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.tree{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.node{border:1px solid #2b3163;border-radius:10px;padding:8px;background:#0f1335}
.node.active{outline:2px solid #7aa8ff}
.node .nhead{display:flex;justify-content:space-between;font-size:12px;color:#cfe0ff;margin-bottom:6px}
.tele{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
table.tele{width:100%;border-collapse:collapse}
table.tele th, table.tele td{border-bottom:1px solid #22284b;padding:6px 4px;text-align:right}
table.tele th:first-child, table.tele td:first-child{text-align:left}
.tele .good{color:#9bffb1}.tele .warn{color:#ffd66b}.tele .bad{color:#ff9b9b}
.bossbox{border:1px solid #5d2b4d;background:linear-gradient(180deg,rgba(246,201,214,.08),rgba(0,0,0,0));border-radius:12px;padding:10px}
/* Equipamiento */
.equip{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.slot{padding:8px;border:1px dashed #394074;border-radius:10px;min-height:68px}
.item{padding:6px;background:#121538;border:1px solid #2b3163;border-radius:8px;margin:4px 0;font-size:12px}
.inv{border:1px solid #2b3163;border-radius:12px;padding:8px;background:#0f1433;max-height:220px;overflow:auto}
.inv-item{display:flex;justify-content:space-between;gap:8px;align-items:center;border:1px solid #2b3163;border-radius:10px;padding:6px 8px;margin:6px 0;background:#121538;font-size:12px}
.inv-item b{font-weight:700}
.small{font-size:11px;color:#a7b0d8}
.muted{opacity:.7}
@media(max-width:1200px){#root{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>üè∞ Torre Arcana ‚Äî v1.13.5 FULL</h1>
  <span class="pill">Seed forzado</span>
  <span class="pill">√Årbol 50+</span>
  <span class="pill">Auras + mejoras</span>
  <span class="pill">Boss Global</span><span class="pill">Mobile Seed Once</span><span class="pill">Emergency Seed</span>
</header>

<div id="root">
  <!-- IZQUIERDA: H√©roes -->
  <section class="card left">
    <h2>H√©roes & Party</h2>
    <div class="section col">
      <div class="row" style="justify-content:space-between">
        <div>H√©roes: <b id="heroes-count">0</b>/<b id="heroes-cap">10</b></div>
        <div>üí∞ <span id="gold" class="money">0</span> ¬∑ üíé <span id="gems" class="gems">0</span> ¬∑ ü™® <span id="souls" class="badge">0</span></div>
      </div>
      <div class="row" style="gap:6px">
        <button id="btn-summon" class="btn-gold">Invocar (5Küí∞)</button>
        <button id="btn-expand" class="btn-accent">Expandir +5 (50Küí∞)</button>
      </div>
      <div class="party" id="party-bar"></div>
      <div class="hero-list" id="hero-list"></div>
    </div>

    <h2>Fusi√≥n de h√©roes</h2>
    <div class="section">
      <div class="row" style="gap:8px">
        <label class="small">Estrellas:</label>
        <select id="fusion-stars"></select>
        <label class="small">Clase del resultado:</label>
        <select id="fusion-class"></select>
      </div>
      <div class="row" style="gap:8px">
        <input id="fusion-name" placeholder="Nombre del nuevo h√©roe (opcional)" style="flex:1">
        <button id="btn-fuse" class="btn-accent">Fusionar (3 ‚Üí 1)</button>
      </div>
      <div class="small muted">3 h√©roes con mismas ‚òÖ ‚Üí nuevo h√©roe +1‚òÖ (m√°x. 7‚òÖ), Lv1, clase/nombre a elecci√≥n.</div>
      <div class="fusion-pool" id="fusion-pool" style="max-height:220px;overflow:auto;border:1px solid #2b3163;border-radius:12px;padding:6px;background:#0f1433"></div>
      <div class="small"><b>Seleccionados:</b> <span id="fuse-count">0</span>/3</div>
    </div>

    <h2>Detalle del h√©roe</h2>
    <div class="section">
      <div class="row" style="justify-content:space-between; margin-bottom:6px">
        <div>
          <span id="sel-hero-name">‚Äî</span>
          <span id="sel-hero-stars"></span>
          <span class="badge" id="sel-hero-lv"></span>
          <span class="badge" id="sel-hero-cls"></span>
          <span class="badge" id="sel-hero-sp">SP: 0</span>
        </div>
        <div class="row" style="gap:6px">
          <button id="btn-train" class="btn-gold">Entrenar</button>
          <button id="btn-dismiss" class="btn-red">Despedir</button>
        </div>
      </div>
      <div class="small" id="train-info"></div>

      <div class="equip" id="equip-grid"></div>

      <div class="row" style="gap:6px;margin-top:6px">
        <select id="inv-filter">
          <option value="all">Inventario: Todos</option>
          <option value="weapon">Arma</option><option value="shield">Escudo</option><option value="helmet">Casco</option>
          <option value="armor">Armadura</option><option value="belt">Cintur√≥n</option><option value="gloves">Guantes</option>
          <option value="boots">Botas</option><option value="ring1">Anillo</option><option value="amulet">Amuleto</option>
          <option value="talisman">Talism√°n</option>
        </select>
        <button id="btn-autoequip" class="btn-accent">Auto-equip mejoras</button>
        <button id="btn-forge" class="btn-accent">Forjar (1Küí∞)</button>
      </div>
      <div class="inv" id="inventory"></div>
    </div>
  </section>

  <!-- CENTRO: Torre + HUD -->
  <section class="card center">
    <h2>Ascenso de la Torre</h2>
    <div class="section">
      <div class="row" style="justify-content:space-between; margin-bottom:8px">
        <div>üè∑Ô∏è Piso <b id="floor">1</b> ¬∑ Oleada <b id="wave">1</b>/<b id="waves">10</b>
          <span id="boss-tag" class="badge" style="display:none;background:#35213a;border-color:#5d2b4d;color:#f6c9d6">JEFE</span>
        </div>
        <div>‚öîÔ∏è Poder equipo: <b id="team-power">0</b></div>
      </div>
      <div class="row" style="gap:8px">
        <label class="small">Comenzar desde:</label>
        <select id="checkpoint-select"></select>
        <button id="btn-apply-check" class="btn-accent">Aplicar checkpoint</button>
        <span class="small">M√°x. alcanzado: <b id="max-reached">1</b></span>
      </div>
      <div class="row" style="gap:8px; margin-top:8px">
        <button id="btn-start">‚ñ∂Ô∏è Iniciar combate</button>
        <button id="btn-pause">‚è∏Ô∏è Pausa</button>
        <button id="btn-skip" title="Saltar al jefe del piso si no est√° activo">‚è≠Ô∏è Saltar piso</button>
        <button id="btn-prestige" title="Reinicia al piso 1 pero ganas gemas">üîÅ Prestigio</button>
        <button id="btn-hardreset" class="btn-danger" title="Borra el guardado y re-seed inicial">üßπ Reset Progreso</button>
      </div>
    </div>

    <h2>HUD de Combate</h2>
    <div class="section">
      <div id="hud" class="hud">
        <div>
          <h3 style="margin:0 0 8px 0; color:#bcd3ff">H√©roes</h3>
          <div id="hud-heroes" class="hud-grid"></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0; color:#f6c9d6">Enemigos</h3>
          <div id="hud-enemies" class="enemy-grid"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- DERECHA: √Årbol + Log + Boss Global + Telemetr√≠a -->
  <section class="card right">
    <h2>Roles, √Årbol & Boss Global</h2>
    <div class="section col">
      <div class="row" style="gap:8px; align-items:center">
        <div>Clase actual: <b id="cls-current">‚Äî</b></div>
        <select id="cls-select"></select>
        <button id="btn-class-change" class="btn-accent">Cambiar clase (20Küí∞)</button>
      </div>
      <div class="small">1 SP cada 5 niveles ¬∑ Reset √°rbol: 5Küí∞</div>
      <div id="tree" class="tree"></div>
      <div class="row" style="gap:8px">
        <button id="btn-reset-tree" class="btn-danger">Resetear √°rbol (5Küí∞)</button>
        <button id="btn-clear-log">Limpiar log</button>
      </div>

      <h2>Registro</h2>
      <div id="log"></div>

      <h2>üëπ Boss Global</h2>
      <div class="bossbox">
        <div class="row" style="justify-content:space-between">
          <div>HP: <b id="gb-hp">‚Äî</b></div>
          <div>Entrada: <b>1</b> ü™®</div>
        </div>
        <div class="row" style="gap:8px; margin-top:6px">
          <button id="btn-gb-enter" class="btn-accent">Entrar (1 ü™®)</button>
          <button id="btn-gb-exit">Salir</button>
          <button id="btn-gb-reset" class="btn-danger" title="Reinicia el Boss Global derrotado">Recrear Boss</button>
        </div>
        <div class="small">Base: Jefe del Piso 15 ‚Ä¢ HP persiste entre intentos. Recompensas: <b>20K oro</b> + <b>√≠tem T4</b>.</div>
      </div>

      <h2>üìä Telemetr√≠a del combate</h2>
      <table class="tele" id="tele-table">
        <thead>
          <tr><th>H√©roe</th><th>Rol</th><th>Da√±o</th><th>DPS</th><th>Curaci√≥n</th><th>HPS</th></tr>
        </thead>
        <tbody id="tele-body"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
(() => {
/* ===== Helpers ===== */
const $=(s)=>document.querySelector(s);
const el=(t,c)=>{const d=document.createElement(t); if(c) d.className=c; return d;};
const nf=(n)=>{if(!isFinite(n))return'0'; if(n<1000)return Math.round(n)+''; const u=['K','M','B','T','Q'];let i=-1;while(n>=1000&&i<u.length-1){n/=1000;i++;}return n.toFixed(2)+u[i];};
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const randint=(a,b)=>Math.round(a+Math.random()*(b-a));

/* ===== Base data ===== */
const CLASSES=['Guerrero','Mago','P√≠caro','Guardi√°n','Sacerdote'];
const SLOTS=['weapon','shield','helmet','armor','belt','gloves','boots','ring1','ring2','amulet','talisman'];
const SLOT_LABEL={weapon:'Arma',shield:'Escudo',helmet:'Casco',armor:'Armadura',belt:'Cintur√≥n',gloves:'Guantes',boots:'Botas',ring1:'Anillo I',ring2:'Anillo II',amulet:'Amuleto',talisman:'Talism√°n'};
const TREE_RESET_COST=5000, CLASS_CHANGE_COST=20000;

/* ===== √Årbol extendido por clase (hasta 50) ===== */
const TREE={
 'Guerrero':[
   {id:'war-a1',name:'+8% ATQ',type:'atk%',val:0.08},
   {id:'war-b1',name:'+6% DEF',type:'def%',val:0.06},
   {id:'war-m-wep1',name:'Maestr√≠a Armas +5%',type:'gear_wep%',val:0.05},
   {id:'war-m-armor1',name:'Maestr√≠a Armadura +5%',type:'gear_arm%',val:0.05},
   {id:'war-aura',name:'Aura ATQ (5%+1%‚òÖ)',type:'party_aura_atk%'},
   {id:'war-aura-up1',name:'Aura ATQ +2%',type:'party_aura_atk+abs',val:0.02},
   {id:'war-a2',name:'+10% ATQ',type:'atk%',val:0.10},
   {id:'war-b2',name:'+8% DEF',type:'def%',val:0.08},
   {id:'war-m-wep2',name:'Maestr√≠a Armas +7%',type:'gear_wep%',val:0.07},
   {id:'war-aura-up2',name:'Aura ATQ +2%',type:'party_aura_atk+abs',val:0.02},
 ],
 'Mago':[
   {id:'mag-a1',name:'+6% ATQ',type:'atk%',val:0.06},
   {id:'mag-c1',name:'+5% CRIT',type:'crit+',val:0.05},
   {id:'mag-m-wep1',name:'Maestr√≠a Bastones +5%',type:'gear_wep%',val:0.05},
   {id:'mag-aura',name:'Aura CRIT (5%+1%‚òÖ)',type:'party_aura_crit+'},
   {id:'mag-aura-up1',name:'Aura CRIT +2%',type:'party_aura_crit+abs',val:0.02},
   {id:'mag-a2',name:'+8% ATQ',type:'atk%',val:0.08},
   {id:'mag-c2',name:'+6% CRIT',type:'crit+',val:0.06},
   {id:'mag-m-jew1',name:'Maestr√≠a Joyer√≠a +5%',type:'gear_jew%',val:0.05},
   {id:'mag-aura-up2',name:'Aura CRIT +2%',type:'party_aura_crit+abs',val:0.02},
 ],
 'P√≠caro':[
   {id:'rog-s1',name:'+8% VEL',type:'spd%',val:0.08},
   {id:'rog-c1',name:'+4% CRIT',type:'crit+',val:0.04},
   {id:'rog-m-wep1',name:'Maestr√≠a Dagas +5%',type:'gear_wep%',val:0.05},
   {id:'rog-aura',name:'Aura VEL (5%+1%‚òÖ)',type:'party_aura_spd%'},
   {id:'rog-aura-up1',name:'Aura VEL +2%',type:'party_aura_spd+abs',val:0.02},
   {id:'rog-s2',name:'+8% VEL',type:'spd%',val:0.08},
   {id:'rog-c2',name:'+5% CRIT',type:'crit+',val:0.05},
   {id:'rog-m-jew1',name:'Maestr√≠a Joyer√≠a +5%',type:'gear_jew%',val:0.05},
   {id:'rog-aura-up2',name:'Aura VEL +2%',type:'party_aura_spd+abs',val:0.02},
 ],
 'Guardi√°n':[
   {id:'grd-d1',name:'+10% DEF',type:'def%',val:0.10},
   {id:'grd-h1',name:'+8% HP',type:'hp%',val:0.08},
   {id:'grd-m-shd1',name:'Maestr√≠a Escudo +6%',type:'gear_shd%',val:0.06},
   {id:'grd-aura',name:'Aura DEF (5%+1%‚òÖ)',type:'party_aura_def%'},
   {id:'grd-aura-up1',name:'Aura DEF +2%',type:'party_aura_def+abs',val:0.02},
   {id:'grd-d2',name:'+12% DEF',type:'def%',val:0.12},
   {id:'grd-h2',name:'+8% HP',type:'hp%',val:0.08},
   {id:'grd-m-arm1',name:'Maestr√≠a Armadura +6%',type:'gear_arm%',val:0.06},
   {id:'grd-aura-up2',name:'Aura DEF +2%',type:'party_aura_def+abs',val:0.02},
 ],
 'Sacerdote':[
   {id:'pri-h1',name:'+8% HP',type:'hp%',val:0.08},
   {id:'pri-a1',name:'+6% ATQ',type:'atk%',val:0.06},
   {id:'pri-heal',name:'Himno (cura 5s, 5%+1%‚òÖ)',type:'heal_activate'},
   {id:'pri-heal-up1',name:'Himno +2% curaci√≥n',type:'heal+abs',val:0.02},
   {id:'pri-m-jew1',name:'Maestr√≠a Joyer√≠a +5%',type:'gear_jew%',val:0.05},
   {id:'pri-heal-up2',name:'Himno +2% curaci√≥n',type:'heal+abs',val:0.02},
   {id:'pri-h2',name:'+8% HP',type:'hp%',val:0.08},
   {id:'pri-a2',name:'+6% ATQ',type:'atk%',val:0.06},
 ]
};

/* ===== Estado ===== */
const DEFAULT={
  floor:1,wave:1,enemiesPerFloor:10,clearedFloors:0,paused:true,
  heroCap:10,gold:25000,gems:0,soulStones:0,
  roster:[],party:[],inventory:[],meta:{prestige:0},startFromFloor:1,globalBoss:null,inGlobalBoss:false
};
let S=null; let enemies=[]; let enemyCD={}; let partyCD={}; let battleActive=false; let priestTick=0;

/* ===== Telemetr√≠a ===== */
let tele={t0:0, perHero:{}};

/* ===== H√©roes / Items ===== */
function rndId(){return 'h'+Math.random().toString(36).slice(2,9);}
function levelCap(stars){return 15+stars*5;} // 1‚òÖ=20 ‚Ä¶ 7‚òÖ=50
function xpForNext(lv){return 24+Math.round(lv*lv*5);}
function rollStars(){const r=Math.random()*100; if(r<1.5)return 5; if(r<11)return 4; if(r<41)return 3; if(r<75)return 2; return 1;}
function baseFromStars(st){const hp=100+st*120+randint(0,st*30), atk=10+st*16+randint(0,st*5), def=3+st*6+randint(0,st*3);
  const spd=+(0.9+st*0.05+Math.random()*0.08).toFixed(2), crit=+(0.02+st*0.012+Math.random()*0.015).toFixed(3); return {hp,atk,def,spd,crit,critDmg:1.5+st*0.05};}
function makeHero(stars=null,cls=null,name=null){
  const st=stars??rollStars(); const nm=name||("Aventurero "+rndId().slice(-3));
  return {id:rndId(),name:nm,cls:cls||CLASSES[Math.floor(Math.random()*CLASSES.length)],stars:st,lv:1,xp:0,
    baseStats:baseFromStars(st),equipment:SLOTS.reduce((a,s)=>(a[s]=null,a),{}),skills:{spent:[]},hpBattle:0,_cacheStats:null};
}

function lvScaling(lv){return 1+(lv-1)*0.10;}
function skillPoints(h){return Math.floor(h.lv/5);} // hasta lvl50 ‚Üí 10 SP
function heroHas(h,id){return (h.skills?.spent||[]).includes(id);}

function sumEquip(hero){const o={atk:0,def:0,hp:0,spd:0,crit:0};
  for(const s of SLOTS){const it=hero.equipment[s]; if(!it) continue;
    o.atk+=it.atk||0; o.def+=it.def||0; o.hp+=it.hp||0; o.spd+=it.spd||0; o.crit+=it.crit||0; }
  return o; }

function gearMasteryMult(hero,slot){
  let mult=1;
  const spent=hero.skills.spent||[];
  const isWep=(slot==='weapon');
  const isArm=(slot==='helmet'||slot==='armor'||slot==='belt'||slot==='gloves'||slot==='boots');
  const isShd=(slot==='shield');
  const isJew=(slot==='ring1'||slot==='ring2'||slot==='amulet'||slot==='talisman');
  for(const id of spent){
    const find=(TREE[hero.cls]||[]).find(n=>n.id===id); if(!find) continue;
    if(find.type==='gear_wep%' && isWep) mult*=1+find.val;
    if(find.type==='gear_arm%' && isArm) mult*=1+find.val;
    if(find.type==='gear_shd%' && isShd) mult*=1+find.val;
    if(find.type==='gear_jew%' && isJew) mult*=1+find.val;
  }
  return mult;
}

function heroBaseTotals(hero){
  const base=hero.baseStats, mult=lvScaling(hero.lv);
  let st={hp:Math.round(base.hp*mult), atk:Math.round(base.atk*mult), def:Math.round(base.def*mult),
          spd:Math.min(5,base.spd), crit:Math.min(0.9,base.crit), critDmg:base.critDmg||1.5};
  // Clase
  if(hero.cls==='Guerrero') st.atk=Math.round(st.atk*1.10);
  if(hero.cls==='Mago'){ st.crit=Math.min(0.9,st.crit+0.05); st.critDmg*=1.15; }
  if(hero.cls==='P√≠caro') st.spd=Math.min(5,st.spd*1.10);
  if(hero.cls==='Guardi√°n') st.def=Math.round(st.def*1.15);
  // Equipo (+maestr√≠as)
  for(const slot of SLOTS){
    const it=hero.equipment[slot]; if(!it) continue;
    const m=gearMasteryMult(hero,slot);
    st.atk += Math.round((it.atk||0)*m);
    st.def += Math.round((it.def||0)*m);
    st.hp  += Math.round((it.hp ||0)*m);
    st.spd = Math.min(5, st.spd + (it.spd||0)*m);
    st.crit= Math.min(0.9, st.crit+ (it.crit||0)*m);
  }
  // √Årbol
  for(const id of hero.skills.spent||[]){
    const nd=(TREE[hero.cls]||[]).find(n=>n.id===id); if(!nd) continue;
    if(nd.type==='atk%') st.atk=Math.round(st.atk*(1+nd.val));
    if(nd.type==='def%') st.def=Math.round(st.def*(1+nd.val));
    if(nd.type==='hp%')  st.hp =Math.round(st.hp *(1+nd.val));
    if(nd.type==='spd%') st.spd=Math.min(5,st.spd*(1+nd.val));
    if(nd.type==='crit+')st.crit=Math.min(0.9,st.crit+nd.val);
  }
  return st;
}

/* ===== Auras y mejoras ===== */
function auraBaseValue(stars){return 0.05+0.01*(clamp(stars,1,7)-1);} // 1‚òÖ=5% ‚Ä¶ 7‚òÖ=11%
function auraBoostFromTree(hero,type){ // devuelve extra absoluto por nodos de mejora
  const spent=hero.skills.spent||[]; let add=0;
  for(const id of spent){
    const nd=(TREE[hero.cls]||[]).find(n=>n.id===id); if(!nd) continue;
    if(nd.type===type) add+=nd.val||0;
  }
  return add;
}
function gatherAuras(){
  const a={atk:0,def:0,hp:0,spd:0,crit:0, healBonus:0}; // healBonus: para sacerdote
  for(const id of S.party){
    const h=S.roster.find(x=>x.id===id); if(!h||h.hpBattle<=0) continue;
    const spent=h.skills.spent||[];
    if(h.cls==='Guerrero' && spent.includes('war-aura')) a.atk+=auraBaseValue(h.stars)+auraBoostFromTree(h,'party_aura_atk+abs');
    if(h.cls==='Mago'     && spent.includes('mag-aura')) a.crit+=auraBaseValue(h.stars)+auraBoostFromTree(h,'party_aura_crit+abs');
    if(h.cls==='P√≠caro'   && spent.includes('rog-aura')) a.spd+=auraBaseValue(h.stars)+auraBoostFromTree(h,'party_aura_spd+abs');
    if(h.cls==='Guardi√°n' && spent.includes('grd-aura')) a.def+=auraBaseValue(h.stars)+auraBoostFromTree(h,'party_aura_def+abs');
    if(h.cls==='Sacerdote'&& spent.includes('pri-heal')) a.healBonus+=auraBoostFromTree(h,'heal+abs'); // mejora absoluta del himno
  }
  return a;
}
function effectiveWithAuras(h){
  const st={...(h._cacheStats||heroBaseTotals(h))}; const a=gatherAuras();
  st.hp =Math.round(st.hp *(1+a.hp));
  st.atk=Math.round(st.atk*(1+a.atk));
  st.def=Math.round(st.def*(1+a.def));
  st.spd=Math.min(5,st.spd*(1+a.spd));
  st.crit=Math.min(0.9,st.crit+a.crit);
  return {st,healAuraBonus:a.healBonus};
}

/* ===== Items (inventario y forja) ===== */
function itemScore(it){return (it.atk||0)*2 + (it.def||0)*1.5 + (it.hp||0)*0.4 + (it.spd||0)*160 + (it.crit||0)*420 + (it.tier||1)*5;}
function genItem(tier=1,slot=null){
  const sl=slot||SLOTS[Math.floor(Math.random()*SLOTS.length)];
  // Distribuci√≥n simple por tier
  const baseAtk = randint(1,3)*tier + (sl==='weapon'?randint(2,6)*tier:0);
  const baseDef = randint(0,2)*tier + (['shield','helmet','armor','gloves','boots','belt'].includes(sl)?randint(2,5)*tier:0);
  const baseHP  = randint(10,40)*tier + (['helmet','armor','belt','gloves','boots'].includes(sl)?randint(20,60)*tier:0);
  const spd = (sl==='boots' || sl==='weapon') ? (Math.random()<0.3 ? +(0.01*tier).toFixed(3) : 0) : 0;
  const crit= (sl==='weapon' || sl.startsWith('ring') || sl==='amulet'||sl==='talisman') ? (Math.random()<0.35 ? +(0.005*tier).toFixed(3) : 0) : 0;
  return {id:'it'+Math.random().toString(36).slice(2,8),name:`${SLOT_LABEL[sl]} T${tier}`,slot:sl,tier,atk:baseAtk,def:baseDef,hp:baseHP,spd:+spd,crit:+crit};
}
function addItemToInv(it){S.inventory.push(it);}
function equipItem(hero,it){
  const cur=hero.equipment[it.slot]; if(cur) S.inventory.push(cur);
  hero.equipment[it.slot]=it;
  S.inventory=S.inventory.filter(x=>x.id!==it.id);
}
function autoEquipBest(hero){
  for(const sl of SLOTS){
    const candidates=S.inventory.filter(i=>i.slot===sl);
    if(!candidates.length) continue;
    const cur=hero.equipment[sl]; const curScore=cur?itemScore(cur):0;
    candidates.sort((a,b)=>itemScore(b)-itemScore(a));
    if(itemScore(candidates[0])>curScore){ equipItem(hero,candidates[0]); }
  }
}
function upgradeItem(item){
  const cost = 500 * (item.tier||1);
  if(S.gold < cost){ log('üí∏ Oro insuficiente para mejorar.'); return; }
  S.gold -= cost;
  item.atk = Math.round((item.atk||0)*1.15+1);
  item.def = Math.round((item.def||0)*1.15+1);
  item.hp  = Math.round((item.hp ||0)*1.15+5);
  if(item.spd)  item.spd += 0.005;
  if(item.crit) item.crit+= 0.002;
  log(`‚¨ÜÔ∏è Mejora: ${item.name} (+stats). Coste ${nf(cost)} oro`);
  const h=S.roster.find(x=>x.id===selectedHeroId); if(h) { renderEquip(h); renderBattleHUD(); }
  renderInventory(); $('#gold').textContent=nf(S.gold);
}

/* ===== Enemigos / Combate ===== */
function enemiesCountForFloor(floor,isBoss){ if(isBoss) return 1; return Math.min(1+Math.floor((floor-1)/2),4); }
function enemyFor(floor,wave,idx,total){
  const isBoss=(wave>=S.enemiesPerFloor);
  const scale=Math.pow(1.18,floor-1), base=1.12;
  const multi= total===1?1: total===2?0.85: total===3?0.75:0.68;
  const hp =Math.round((180+26*floor)*scale*(isBoss?7.4:1)*base*multi);
  const atk=Math.round((14+3.2*floor)*scale*(isBoss?2.4:1)*base*multi);
  const def=Math.round((5+1.4*floor)*scale*(isBoss?1.8:1)*base*multi);
  const spd=Math.min(3.5,(0.85+0.012*floor+(isBoss?0.06:0))*(total>1?0.95:1));
  return {id:'e'+Math.random().toString(36).slice(2,7),name=isBoss?`Jefe ${floor}`:`Enemigo ${wave}-${idx+1}`,type:isBoss?'Jefe':'Normal',hpMax:hp,hp:hp,atk,def,spd,isBoss};
}
function baseGoldForEnemy(e){ const base=(16+6*S.floor)*(e.isBoss?5.2:1); return Math.round(base); }
function genDrop(e){
  if(Math.random()<0.18){
    const tier = Math.max(1, Math.min(6, Math.floor((S.floor+3)/4)));
    return genItem(tier);
  }
  return null;
}
function dmg(atk,def){ const raw=atk - def*0.65; return Math.max(1, Math.round(raw * (0.85 + Math.random()*0.3))); }
function pickEnemy(){ const alive=enemies.filter(e=>e.hp>0); if(!alive.length) return null; alive.sort((a,b)=>(a.hp/a.hpMax)-(b.hp/b.hpMax)); return alive[0]; }

function heroAttack(h){
  const {st}=effectiveWithAuras(h); const t=pickEnemy(); if(!t) return;
  const crit = Math.random() < st.crit; let d = dmg(st.atk, t.def) * (crit ? (h._cacheStats?.critDmg||1.5) : 1);
  d=Math.round(d); t.hp=Math.max(0, t.hp - d); updateEnemyHP(t); teleAddDmg(h.id,d);
  if (t.hp<=0){
    const reward=baseGoldForEnemy(t); S.gold+=reward; log((t.isBoss?'üèÜ ':'‚úÖ ')+`${t.name} derrotado. +${nf(reward)} oro`);
    if (t.isBoss){ S.soulStones=(S.soulStones||0)+1; $('#souls').textContent=S.soulStones; log('ü™® +1 Piedra de Alma'); }
    const drop=genDrop(t); if(drop){ addItemToInv(drop); log(`üéÅ Bot√≠n: ${drop.name}`); renderInventory(); }
    if (!enemies.some(x=>x.hp>0)) nextWaveOrFloor();
  }
  renderTele();
  if (S.inGlobalBoss && t.id==='gb'){ S.globalBoss.hp=t.hp; updateGB(); if (S.globalBoss.hp<=0) onGBDeath(); }
}

function enemyAttack(e){
  const alive=S.party.map(id=>S.roster.find(x=>x.id===id)).filter(h=>h.hpBattle>0);
  if (!alive.length) return; const target=alive[Math.floor(Math.random()*alive.length)];
  const {st}=effectiveWithAuras(target); let d=Math.max(1, Math.round(dmg(e.atk, st.def)));
  target.hpBattle=Math.max(0, target.hpBattle-d); updateHeroHP(target);
  if (target.hpBattle<=0){
    log(`üíÄ ${target.name} ha ca√≠do.`);
    const anyAlive = S.party.map(id=>S.roster.find(h=>h.id===id)).some(h=>h.hpBattle>0);
    if (!anyAlive){
      if (S.inGlobalBoss){ log('‚ò†Ô∏è Equipo derrotado en Boss Global. El HP del Boss NO se recupera.'); stopBattle(); updateGB(); }
      else { onPartyWipe(); }
    }
  }
}

/* Sacerdote ‚Äî Himno cada 5s: 5% + 1%‚òÖ, no stack base; mejoras absolutas se suman */
function priestHealing(dt){
  const priests=S.party.map(id=>S.roster.find(h=>h.id===id)).filter(h=>h && h.cls==='Sacerdote' && heroHas(h,'pri-heal') && h.hpBattle>0);
  if (!priests.length) return;
  let basePct = 0; let addAbs=0;
  for(const p of priests){ basePct = Math.max(basePct, (0.05 + 0.01*(clamp(p.stars,1,7)-1))); addAbs += auraBoostFromTree(p,'heal+abs'); }
  priestTick+=dt;
  while (priestTick>=5){
    priestTick-=5;
    for(const id of S.party){
      const h=S.roster.find(x=>x.id===id); if (!h || h.hpBattle<=0) continue;
      const {st}=effectiveWithAuras(h); const pct = basePct + addAbs;
      const heal=Math.max(1, Math.round(st.hp*pct));
      const before=h.hpBattle; h.hpBattle=Math.min(st.hp, h.hpBattle+heal);
      const gained=h.hpBattle-before; if (gained>0){ teleAddHeal(h.id,gained); log(`‚ú® ${h.name} +${gained} HP (${Math.round(pct*100)}%)`); updateHeroHP(h); }
    }
    renderTele();
  }
}

/* ===== Boss Global ===== */
function createGlobalBoss(){ const b=enemyFor(15,10,0,1); return {hpMax:b.hpMax,hp:b.hpMax,atk:b.atk,def:b.def,spd:Math.max(1,b.spd),name:'Boss Global',tierDrop:4}; }
function enterGlobalBoss(){
  if ((S.soulStones||0)<1){ log('ü™® No tienes piedras de alma.'); return; }
  if (S.inGlobalBoss){ log('Ya est√°s en el Boss Global.'); return; }
  S.soulStones-=1; S.inGlobalBoss=true; log('üö™ Entras al Boss Global (-1 ü™®).');
  enemies=[{id:'gb',name:'Boss Global',type:'Jefe',hpMax:S.globalBoss.hpMax,hp:S.globalBoss.hp,atk:S.globalBoss.atk,def:S.globalBoss.def,spd:S.globalBoss.spd,isBoss:true}];
  enemyCD={'gb':1/enemies[0].spd}; preparePartyForBattle(true); renderEnemiesHUD(); updateGB(); if (!battleActive) startBattle();
}
function exitGlobalBoss(){ if (!S.inGlobalBoss){ log('No est√°s en el Boss Global.'); return; } S.inGlobalBoss=false; log('üö™ Sales del Boss Global.'); spawnEnemies(true); }
function onGBDeath(){
  log('üèÜ ¬°Boss Global derrotado! +20K oro + √≠tem T4.'); S.gold+=20000;
  const slot=SLOTS[Math.floor(Math.random()*SLOTS.length)]; const item={slot,tier:4,plus:0,atk:20,def:12,hp:120,spd:0.02,crit:0.01,name:`${SLOT_LABEL[slot]} T4`,id:'it'+Math.random().toString(36).slice(2,8)};
  addItemToInv(item); log(`üéÅ Bot√≠n: ${item.name} ‚Üí revisa inventario`); renderInventory();
  S.globalBoss=createGlobalBoss(); S.inGlobalBoss=false; updateGB(); spawnEnemies(true);
}
function updateGB(){ $('#gb-hp').textContent=`${nf(S.globalBoss.hp)}/${nf(S.globalBoss.hpMax)}`; }

/* ===== Persistencia + Seed forzado + Log ===== */


function load(){
  let forcedSeed=false;
  try{
    const raw=localStorage.getItem('tower_state_v1_13');
    S = raw ? {...DEFAULT, ...JSON.parse(raw)} : {...DEFAULT};
  }catch(e){
    S = {...DEFAULT};
  }
  if(!S || typeof S!=='object') S={...DEFAULT};
  if(!Array.isArray(S.roster)) S.roster=[];
  if(!Array.isArray(S.party)) S.party=[];
  if(!Array.isArray(S.inventory)) S.inventory=[];

  // === Seed agresivo: si oro <= 0 o roster vac√≠o, resembrar SIEMPRE ===
  if(!Number.isFinite(S.gold) || S.gold<=0 || !S.roster.length){
    S={...DEFAULT};
    const h=makeHero(1,'Guerrero','Auron A');
    S.roster=[h]; S.party=[h.id]; S.gold=25000; S.floor=1; S.wave=1;
    for(const sl of SLOTS){ if(Math.random()<0.3){ const it=genItem(1,sl); h.equipment[sl]=it; } }
    for(let i=0;i<6;i++) S.inventory.push(genItem(1));
    forcedSeed=true;
  }

  if(!S.party.length && S.roster.length) S.party=[S.roster[0].id];
  if(!S.globalBoss) S.globalBoss=createGlobalBoss();

  if(forcedSeed){
    const bn=document.createElement('div');
    bn.style.position='fixed'; bn.style.top='0'; bn.style.left='0'; bn.style.right='0'; bn.style.zIndex='9999';
    bn.style.padding='6px'; bn.style.textAlign='center'; bn.style.fontWeight='bold';
    bn.style.background='#e09f3e'; bn.style.color='#0b0d1a';
    bn.textContent='SEED DE EMERGENCIA APLICADO ‚Äî 25K oro + h√©roe inicial';
    document.addEventListener('DOMContentLoaded',()=>setTimeout(()=>bn.remove(),4000));
    document.body.appendChild(bn);
  }
}


function save(){ localStorage.setItem('tower_state_v1_13', JSON.stringify(S)); }

const logLines=[]; let LOG_MAX=300;
function trimLog(){ while(logLines.length>LOG_MAX) logLines.shift(); $('#log').textContent=logLines.join('\n'); const e=$('#log'); e.scrollTop=e.scrollHeight; }
function log(msg){ const t=new Date().toLocaleTimeString(); logLines.push(`[${t}] ${msg}`); trimLog(); }
$('#btn-clear-log').onclick=()=>{ logLines.length=0; trimLog(); };

/* ===== UI: Roster / Party ===== */
let selectedHeroId=null; let fusionSelected=new Set(); let fusionStarsFilter=1;
function heroPower(h){ const s=heroBaseTotals(h); return Math.round(s.atk*2+s.def*1.8+s.hp*0.45+s.spd*170+s.crit*450+h.stars*50); }

function renderPartyBar(){ const bar=$('#party-bar'); bar.innerHTML='';
  for(let i=0;i<4;i++){ const id=S.party[i]; const slot=el('div','party-slot');
    if(id){ const h=S.roster.find(x=>x.id===id), st=heroBaseTotals(h); slot.innerHTML=`<b>${h.name}</b><div style="font-size:11px">HP ${nf(st.hp)} ¬∑ ATQ ${nf(st.atk)} ¬∑ DEF ${nf(st.def)}</div>`; }
    else slot.innerHTML='<span style="opacity:.6">Vac√≠o</span>'; bar.appendChild(slot);
  }
  $('#team-power').textContent=nf(S.party.map(id=>heroPower(S.roster.find(x=>x.id===id)||{baseStats:{}})).reduce((a,b)=>a+b,0));
}

function renderRoster(){
  $('#heroes-count').textContent=S.roster.length; $('#heroes-cap').textContent=S.heroCap;
  $('#gold').textContent=nf(S.gold); $('#gems').textContent=nf(S.gems); $('#souls').textContent=S.soulStones||0;
  const list=$('#hero-list'); list.innerHTML='';
  for(const h of S.roster){
    const card=el('div','hero-card'+(h.id===selectedHeroId?' selected':'')); card.innerHTML=`
      <div class="row" style="justify-content:space-between"><b>${h.name}</b><span class="star">${'‚òÖ'.repeat(h.stars)}</span></div>
      <div class="row" style="justify-content:space-between"><span class="badge">${h.cls}</span><span class="badge">Lv.${h.lv}/${levelCap(h.stars)}</span></div>
      <div class="row" style="justify-content:space-between"><span class="badge">PWR ${nf(heroPower(h))}</span></div>
      <div class="row" style="gap:6px;margin-top:4px">
        <button data-act="party">${S.party.includes(h.id)?'Quitar':'Agregar'}</button>
        <button data-act="select">Ver</button>
        <button data-act="dismiss" class="btn-red">Despedir</button>
      </div>`;
    card.querySelector('[data-act="party"]').onclick=()=>toggleParty(h.id);
    card.querySelector('[data-act="select"]').onclick=()=>{ selectedHeroId=h.id; renderRoster(); renderEquip(h); renderTree(); };
    card.querySelector('[data-act="dismiss"]').onclick=()=>dismissHero(h.id);
    list.appendChild(card);
  }
  renderPartyBar(); renderFusionUI();
}

function toggleParty(id){ const i=S.party.indexOf(id); if(i>=0) S.party.splice(i,1); else { if (S.party.length<4) S.party.push(id); else {log('‚ö†Ô∏è Party llena (4).'); return;} } renderRoster(); renderBattleHUD(); }
function dismissHero(id){ const h=S.roster.find(x=>x.id===id); if(!h) return; if(S.roster.length<=1){ log('‚õî Debe quedar al menos 1 h√©roe.'); return; }
  if(!confirm(`¬øDespedir a ${h.name}?`)) return; S.party=S.party.filter(x=>x!==id); S.roster=S.roster.filter(x=>x.id!==id); if(selectedHeroId===id) selectedHeroId=S.roster[0]?.id||null;
  log(`üëã ${h.name} despedido.`); renderRoster(); if(selectedHeroId){ const sh=S.roster.find(x=>x.id===selectedHeroId); if(sh) renderEquip(sh);} renderBattleHUD(); renderTree(); }

/* ===== Equip UI ===== */
function formatStats(it){const p=[]; if(it.atk)p.push(`ATQ+${it.atk}`); if(it.def)p.push(`DEF+${it.def}`); if(it.hp)p.push(`HP+${it.hp}`); if(it.spd)p.push(`VEL+${it.spd.toFixed(3)}`); if(it.crit)p.push(`CRIT+${(it.crit*100).toFixed(1)}%`); return p.join(', ');}
function renderEquip(hero){
  $('#sel-hero-name').textContent=hero.name;
  $('#sel-hero-stars').innerHTML='<span class="star">'+'‚òÖ'.repeat(hero.stars)+'</span>';
  $('#sel-hero-lv').textContent=`Lv.${hero.lv}/${levelCap(hero.stars)} (${hero.xp}/${xpForNext(hero.lv)} XP)`;
  $('#sel-hero-cls').textContent=hero.cls;
  $('#sel-hero-sp').textContent=`SP: ${skillPoints(hero) - (hero.skills.spent||[]).length}`;
  const grid=$('#equip-grid'); grid.innerHTML='';
  for(const sl of SLOTS){
    const it=hero.equipment[sl]; const div=el('div','slot');
    if(it){ div.innerHTML=`<b>${SLOT_LABEL[sl]}</b>
        <div class="item"><b>${it.name}</b><br>${formatStats(it)}</div>
        <div class="row">
          <button data-upg="${it.id}" class="small btn-accent">Mejorar</button>
          <button data-un="${sl}" class="small">Quitar</button>
        </div>`; }
    else { div.innerHTML=`<b>${SLOT_LABEL[sl]}</b><div class="item" style="opacity:.6">‚Äî vac√≠o ‚Äî</div>`; }
    grid.appendChild(div);
  }
  grid.querySelectorAll('button[data-un]').forEach(b=>{
    b.onclick=()=>{ const sl=b.getAttribute('data-un'); const it=hero.equipment[sl]; if(!it) return; S.inventory.push(it); hero.equipment[sl]=null; log(`üß≥ ${hero.name} quit√≥ ${it.name}`); renderEquip(hero); renderInventory(); renderBattleHUD(); };
  });
  grid.querySelectorAll('button[data-upg]').forEach(b=>{
    b.onclick=()=>{ const id=b.getAttribute('data-upg'); const it=Object.values(hero.equipment).find(x=>x&&x.id===id); if(!it) return; upgradeItem(it); };
  });
  const trainC=200*hero.lv; const xpChunk=Math.round(xpForNext(hero.lv)*0.25);
  const info=$("#train-info"); if(info) info.textContent=`Entrenar: ${nf(trainC)} oro ‚Üí +${xpChunk} XP`;
  renderInventory();
}

function renderInventory(){
  const inv=$('#inventory'); inv.innerHTML='';
  const filter=$('#inv-filter').value;
  const h=S.roster.find(x=>x.id===selectedHeroId); if(!h) return;
  const list=S.inventory.filter(it=>filter==='all' || it.slot===filter || (filter==='ring1' && it.slot==='ring2'));
  if(!list.length){ inv.innerHTML='<div class="small muted">Inventario vac√≠o o sin piezas del filtro.</div>'; return; }
  for(const it of list){
    const row=el('div','inv-item'); const score=itemScore(it);
    row.innerHTML=`<span><b>${it.name}</b> <span class="badge">T${it.tier}</span> <span class="small">${SLOT_LABEL[it.slot]}</span><br><span class="small">${formatStats(it)}</span></span>
      <span class="row">
        <button data-eq="${it.id}" class="btn-accent">Equipar</button>
        <button data-upgi="${it.id}" class="small">Mejorar</button>
      </span>`;
    row.querySelector('button[data-eq]').onclick=()=>{ equipItem(h,it); log(`üó°Ô∏è ${h.name} equipa ${it.name}`); renderEquip(h); renderBattleHUD(); };
    row.querySelector('button[data-upgi]').onclick=()=>upgradeItem(it);
    inv.appendChild(row);
  }
}
$('#inv-filter').onchange=()=>renderInventory();
$('#btn-forge').onclick=()=>{ const cost=1000; if(S.gold<cost){log('üí∏ Oro insuficiente para forjar.'); return;} S.gold-=cost; const item=genItem(Math.random()<0.3?2:1); addItemToInv(item); log(`‚öíÔ∏è Forjado: ${item.name}`); renderInventory(); $('#gold').textContent=nf(S.gold); };
$('#btn-autoequip').onclick=()=>{ const h=S.roster.find(x=>x.id===selectedHeroId); if(!h) return; autoEquipBest(h); renderEquip(h); renderBattleHUD(); log(`‚ú® Auto-equip completado para ${h.name}`); };

/* ===== Entrenar / Despedir ===== */
$('#btn-train').onclick=()=>{
  const h=S.roster.find(x=>x.id===selectedHeroId); if(!h) return;
  const cost=200*h.lv; if(S.gold<cost){ log('üí∏ Oro insuficiente para entrenar.'); return; }
  S.gold-=cost; const xpChunk=Math.round(xpForNext(h.lv)*0.25); h.xp+=xpChunk;
  while(h.lv<levelCap(h.stars) && h.xp>=xpForNext(h.lv)){ h.xp-=xpForNext(h.lv); h.lv++; log(`üîº ${h.name} sube a nivel ${h.lv}`); }
  if(h.lv>=levelCap(h.stars)) h.xp=0;
  renderEquip(h); renderRoster();
};
$('#btn-dismiss').onclick=()=>{ if(!selectedHeroId) return; dismissHero(selectedHeroId); };

/* ===== Fusi√≥n ===== */
function renderFusionUI(){
  const starsSel=$('#fusion-stars'); if(!starsSel.options.length){ for(let s=1;s<=7;s++){ const o=document.createElement('option'); o.value=s;o.textContent=`${s}‚òÖ`; starsSel.appendChild(o);} starsSel.value=fusionStarsFilter; starsSel.onchange=()=>{fusionStarsFilter=+starsSel.value;fusionSelected.clear();renderFusionPool();}; }
  const clsSel=$('#fusion-class'); if(!clsSel.options.length){ for(const c of CLASSES){ const o=document.createElement('option'); o.value=c;o.textContent=c; clsSel.appendChild(o);} }
  renderFusionPool(); $('#fuse-count').textContent=String(fusionSelected.size);
}
function renderFusionPool(){
  const pool=$('#fusion-pool'); pool.innerHTML=''; const list=S.roster.filter(h=>h.stars===fusionStarsFilter);
  if(!list.length){ pool.innerHTML='<div class="small muted">No hay h√©roes de esas estrellas.</div>'; return; }
  for(const h of list){
    const div=el('div','inv-item'); const checked=fusionSelected.has(h.id);
    div.innerHTML=`<span><b>${h.name}</b> <span class="star">${'‚òÖ'.repeat(h.stars)}</span> <span class="badge">${h.cls}</span> <span class="badge">Lv ${h.lv}</span></span>
    <span class="row"><button data-sel="${h.id}">${checked?'Quitar':'Elegir'}</button></span>`;
    div.querySelector('button').onclick=()=>{ if(fusionSelected.has(h.id)) fusionSelected.delete(h.id); else { if(fusionSelected.size>=3){log('‚ö†Ô∏è Debes quitar uno para cambiar.'); return;} fusionSelected.add(h.id);} $('#fuse-count').textContent=String(fusionSelected.size); renderFusionPool(); };
    pool.appendChild(div);
  }
}
$('#btn-fuse').onclick=()=>{
  if (fusionSelected.size!==3){ log('‚õî Selecciona exactamente 3 h√©roes.'); return; }
  const ids=[...fusionSelected]; const hs=ids.map(id=>S.roster.find(h=>h.id===id)); const s=hs[0].stars; if(!hs.every(h=>h.stars===s)){ log('‚õî Deben tener las mismas estrellas.'); return; }
  const resultStars=Math.min(7,s+1); const cls=$('#fusion-class').value||'Guerrero'; const name=($('#fusion-name').value||`Fusionado ${resultStars}‚òÖ`).trim();
  S.roster=S.roster.filter(h=>!ids.includes(h.id)); S.party=S.party.filter(id=>!ids.includes(id));
  const newH=makeHero(resultStars, cls, name); newH.skills.spent=[]; S.roster.push(newH); if(S.party.length<4) S.party.push(newH.id);
  selectedHeroId=newH.id; fusionSelected.clear(); $('#fusion-name').value=''; log(`üîó Fusi√≥n: 3√ó${s}‚òÖ ‚Üí ${name} (${cls}) ${resultStars}‚òÖ`);
  renderRoster(); renderEquip(newH); renderBattleHUD(); renderFusionPool(); save();
};

/* ===== √Årbol / Clase ===== */
function renderTree(){
  const h=S.roster.find(x=>x.id===selectedHeroId)||S.roster[0]; if(!h) return;
  const sel=$('#cls-select'); if(!sel.options.length){ for(const c of CLASSES){ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);} }
  sel.value=h.cls; $('#cls-current').textContent=h.cls;
  const spAvail=skillPoints(h)-(h.skills.spent||[]).length;
  const tree=$('#tree'); tree.innerHTML='';
  for(const nd of (TREE[h.cls]||[])){
    const active=(h.skills.spent||[]).includes(nd.id);
    const n=el('div','node'+(active?' active':'')); n.innerHTML=`<div class="nhead"><span>${nd.name}</span><span>${active?'Tomado':'Libre'}</span></div>
      <button ${active?'disabled':''} data-node="${nd.id}">Aprender (${spAvail>0?'1 SP':'0 SP'})</button>`;
    tree.appendChild(n);
  }
  tree.querySelectorAll('button[data-node]').forEach(btn=>{
    btn.onclick=()=>{ const nodeId=btn.getAttribute('data-node'); const left=skillPoints(h)-(h.skills.spent||[]).length;
      if ((h.skills.spent||[]).includes(nodeId)) return; if (left<=0){ log('‚õî No tienes SP suficientes.'); return; }
      h.skills.spent=(h.skills.spent||[]).concat([nodeId]); const node=(TREE[h.cls]||[]).find(n=>n.id===nodeId);
      log(`üß† ${h.name} aprendi√≥ ${node?.name||'una habilidad'}.`); renderTree(); renderRoster(); renderBattleHUD(); };
  });
}
$('#btn-reset-tree').onclick=()=>{ const h=S.roster.find(x=>x.id===selectedHeroId); if(!h) return;
  if (S.gold < TREE_RESET_COST){ log('üí∏ No tienes oro suficiente para resetear.'); return; } S.gold-=TREE_RESET_COST; h.skills.spent=[]; log(`‚ôªÔ∏è √Årbol de ${h.name} reseteado.`); renderTree(); renderRoster(); renderBattleHUD(); };
$('#btn-class-change').onclick=()=>{ const h=S.roster.find(x=>x.id===selectedHeroId); if(!h) return; const newCls=$('#cls-select').value;
  if (h.cls===newCls){ log('‚ÑπÔ∏è Ya tiene esa clase.'); return; } if (S.gold < CLASS_CHANGE_COST){ log('üí∏ Oro insuficiente para cambiar de clase.'); return; }
  S.gold-=CLASS_CHANGE_COST; h.cls=newCls; h.skills.spent=[]; log(`üîÑ ${h.name} ahora es ${h.cls}. (√Årbol reseteado)`); renderTree(); renderRoster(); renderBattleHUD(); };

/* ===== HUD ===== */
function renderEnemiesHUD(){ const grid=$('#hud-enemies'); grid.innerHTML=''; for(const e of enemies){ const box=el('div','unit'); box.id='enemy-'+e.id;
    box.innerHTML=`<h3>${e.name} ${e.isBoss?'<span class="badge" style="background:#35213a;border-color:#5d2b4d;color:#f6c9d6">Jefe</span>':''}</h3>
      <div class="urow"><span>ATQ <b>${nf(e.atk)}</b></span><span>DEF <b>${nf(e.def)}</b></span></div>
      <div class="urow"><span>VEL <b>${e.spd.toFixed(2)}</b></span><span>HP <b id="ehptext-${e.id}">${nf(e.hp)}/${nf(e.hpMax)}</b></span></div>
      <div class="hpwrap" style="border:1px solid #2b3163;border-radius:10px;overflow:hidden"><div id="ehpbar-${e.id}" class="ehpbar" style="width:${(e.hp/e.hpMax)*100}%"></div></div>`;
    grid.appendChild(box);
  } }
function updateEnemyHP(e){ const bar=document.getElementById('ehpbar-'+e.id); const txt=document.getElementById('ehptext-'+e.id); if(!bar||!txt) return; const pct=Math.max(0,e.hp/e.hpMax)*100; bar.style.width=pct+'%'; txt.textContent=`${nf(e.hp)}/${nf(e.hpMax)}`; }
function renderBattleHUD(){ const grid=$('#hud-heroes'); grid.innerHTML=''; for(const id of S.party){ const h=S.roster.find(x=>x.id===id); if(!h) continue; const st=heroBaseTotals(h); if(!h.hpBattle||battleActive===false) h.hpBattle=st.hp;
    const box=el('div','unit'); box.id='unit-'+h.id; box.innerHTML=`<h3>${h.name} <span class="star">${'‚òÖ'.repeat(h.stars)}</span></h3>
      <div class="urow"><span>${h.cls}</span><span>Lv ${h.lv}/${levelCap(h.stars)}</span></div>
      <div class="urow"><span>ATQ <b>${nf(st.atk)}</b></span><span>DEF <b>${nf(st.def)}</b></span></div>
      <div class="urow"><span>VEL <b>${st.spd.toFixed(2)}</b></span><span>CRIT <b>${Math.round(st.crit*100)}%</b></span></div>
      <div class="urow"><span>HP</span><span><b id="hptext-${h.id}">${nf(h.hpBattle)}/${nf(st.hp)}</b></span></div>
      <div class="hpwrap" style="border:1px solid #2b3163;border-radius:10px;overflow:hidden"><div id="hpbar-${h.id}" class="hpbar" style="width:${(h.hpBattle/st.hp)*100}%"></div></div>`;
    grid.appendChild(box);
  } }
function updateHeroHP(hero){ const st=heroBaseTotals(hero); const bar=document.getElementById('hpbar-'+hero.id); const txt=document.getElementById('hptext-'+hero.id); if(!bar||!txt) return; const pct=Math.max(0,hero.hpBattle/st.hp)*100; bar.style.width=pct+'%'; txt.textContent=`${nf(hero.hpBattle)}/${nf(st.hp)}`; }

/* ===== Telemetr√≠a ===== */
function teleReset(){ tele={t0:performance.now(),perHero:{}}; for(const id of S.party){ tele.perHero[id]={dmg:0,heal:0}; } renderTele(); }
function teleAddDmg(id,amt){ if(!tele.perHero[id]) tele.perHero[id]={dmg:0,heal:0}; tele.perHero[id].dmg+=amt; }
function teleAddHeal(id,amt){ if(!tele.perHero[id]) tele.perHero[id]={dmg:0,heal:0}; tele.perHero[id].heal+=amt; }
function renderTele(){ const tbody=$('#tele-body'); tbody.innerHTML=''; const t=(performance.now()-tele.t0)/1000||1;
  for(const id of S.party){ const h=S.roster.find(x=>x.id===id); if(!h) continue; const d=tele.perHero[id]?.dmg||0; const he=tele.perHero[id]?.heal||0;
    const tr=el('tr',''); tr.innerHTML=`<td>${h.name}</td><td>${h.cls}</td><td>${nf(d)}</td><td>${(d/t).toFixed(1)}</td><td>${nf(he)}</td><td>${(he/t).toFixed(1)}</td>`; tbody.appendChild(tr); }}

/* ===== Control de combate ===== */
function preparePartyForBattle(resetHP){
  partyCD={}; for(const id of S.party){ const h=S.roster.find(x=>x.id===id); const st=heroBaseTotals(h);
    if(resetHP){ h.hpBattle=st.hp; } h._cacheStats=st; partyCD[id]=1/st.spd; }
}
function startBattle(){ if(S.party.length===0){log('‚ö†Ô∏è No tienes h√©roes en la party.'); return;} battleActive=true; S.paused=false; preparePartyForBattle(true); teleReset(); log('‚ñ∂Ô∏è Combate iniciado.'); renderBattleHUD(); renderEnemiesHUD(); }
function stopBattle(){ battleActive=false; S.paused=true; log('‚èπÔ∏è Combate detenido.'); }
function onPartyWipe(){ log('‚ò†Ô∏è ¬°Tu equipo ha ca√≠do! Reinicias en tu checkpoint.'); stopBattle(); S.floor=S.startFromFloor||1; S.wave=1; spawnEnemies(true); }
function grantXP(xp){ for(const id of S.party){ const h=S.roster.find(x=>x.id===id); const cap=levelCap(h.stars); if(h.lv>=cap) continue;
  h.xp+=xp; while(h.lv<cap && h.xp>=xpForNext(h.lv)){ h.xp-=xpForNext(h.lv); h.lv++; log(`üîº ${h.name} sube a nivel ${h.lv}`); } if(h.lv>=cap) h.xp=0; } renderRoster(); }

function nextWaveOrFloor(){
  if (S.wave >= S.enemiesPerFloor){
    S.clearedFloors=Math.max(S.clearedFloors,S.floor);
    S.floor++; S.wave=1;
    for(const id of S.party){ const h=S.roster.find(x=>x.id===id); const st=heroBaseTotals(h); h.hpBattle=st.hp; h._cacheStats=null; }
    log(`‚¨ÜÔ∏è Piso ${S.floor}. Todos reviven y curan al 100%.`); renderCheckpointSelect();
  } else { S.wave++; }
  spawnEnemies(true);
}

/* ===== Spawns ===== */
function spawnEnemies(resetWave=false){
  if (S.inGlobalBoss){
    enemies=[{id:'gb',name:'Boss Global',type:'Jefe',hpMax:S.globalBoss.hpMax,hp:S.globalBoss.hp,atk:S.globalBoss.atk,def:S.globalBoss.def,spd:S.globalBoss.spd,isBoss:true}];
    enemyCD={'gb':1/enemies[0].spd}; $('#boss-tag').style.display=''; renderEnemiesHUD(); updateGB(); return;
  }
  if (resetWave) S.wave=clamp(S.wave,1,S.enemiesPerFloor);
  const count=enemiesCountForFloor(S.floor, S.wave>=S.enemiesPerFloor);
  enemies=[]; for(let i=0;i<count;i++) enemies.push(enemyFor(S.floor,S.wave,i,count));
  enemyCD={}; for(const e of enemies) enemyCD[e.id]=1/e.spd;
  $('#boss-tag').style.display=(S.wave>=S.enemiesPerFloor)?'':'none';
  renderEnemiesHUD();
}

/* ===== Checkpoints ===== */
function highestCheckpointUnlocked(){ const max=Math.max(1,S.clearedFloors); return Math.max(1, Math.floor(max/5)*5); }
function renderCheckpointSelect(){
  const sel=$('#checkpoint-select'); sel.innerHTML=''; const hi=highestCheckpointUnlocked(); const options=[{v:1,label:'Piso 1'}];
  for(let f=5; f<=hi; f+=5) options.push({v:f,label:`Piso ${f}`});
  for(const o of options){ const opt=document.createElement('option'); opt.value=o.v; opt.textContent=o.label; sel.appendChild(opt); }
  const exists=[...sel.options].some(o=>+o.value===S.startFromFloor); sel.value=exists?S.startFromFloor:hi; $('#max-reached').textContent=String(Math.max(1,S.clearedFloors));
}
$('#btn-apply-check').onclick=()=>{ const v=+($('#checkpoint-select').value||'1'); S.startFromFloor=Math.max(1,v); S.floor=S.startFromFloor; S.wave=1;
  log(`üìç Checkpoint aplicado: piso ${S.startFromFloor}.`); spawnEnemies(true); renderCheckpointSelect(); };

/* ===== Botones ===== */
$('#btn-start').onclick=()=>{ if (battleActive) log('Ya est√°s en combate.'); else startBattle(); };
$('#btn-pause').onclick=()=>{ S.paused=!S.paused; log(S.paused?'‚è∏Ô∏è Pausa':'‚ñ∂Ô∏è Reanudar'); };
$('#btn-skip').onclick=()=>{ if (S.inGlobalBoss){ log('No puedes saltar en Boss Global.'); return; } if (enemies.some(e=>e.isBoss && e.hp>0)){ log('‚ö†Ô∏è No puedes saltar con el Jefe vivo.'); return; } S.wave=S.enemiesPerFloor; spawnEnemies(true); log('‚è≠Ô∏è Saltas a la oleada del Jefe.'); };
$('#btn-prestige').onclick=()=>{ if (S.clearedFloors < 20){ log('‚ùå Necesitas al menos Piso 20 limpio para prestigiar.'); return; }
  const gained=Math.floor(S.clearedFloors/20); S.gems=(S.gems||0)+gained; S.meta=S.meta||{}; S.meta.prestige=(S.meta.prestige||0)+1; log(`üîÅ Prestigio hecho. +${gained} gemas.`);
  const roster=JSON.parse(JSON.stringify(S.roster)); const cap=S.heroCap; const keepParty=S.party.slice(0); const gb=S.globalBoss; const inv=S.inventory;
  S={...DEFAULT}; S.roster=roster; S.heroCap=cap; S.globalBoss=gb; S.inventory=inv; S.party=keepParty.filter(id=>S.roster.find(h=>h.id===id)).slice(0,4); S.startFromFloor=1; spawnEnemies(true); drawAll(); renderCheckpointSelect(); };

$('#btn-summon').onclick=()=>{ const cost=5000; if (S.gold<cost){ log('üí∏ Oro insuficiente para invocar.'); return; } if (S.roster.length>=S.heroCap){ log('üì¶ L√≠mite de h√©roes alcanzado.'); return; }
  S.gold-=cost; const h=makeHero(); S.roster.push(h); log(`‚ú® Invocado ${h.name} ‚Äî ${'‚òÖ'.repeat(h.stars)} (${h.cls})`); if (S.party.length<4) S.party.push(h.id); selectedHeroId=h.id; renderRoster(); renderEquip(h); renderBattleHUD(); renderTree(); };

$('#btn-expand').onclick=()=>{ const cost=50000; if (S.gold<cost){ log('üí∏ Oro insuficiente.'); return; } S.gold-=cost; S.heroCap+=5; log(`üì¶ L√≠mite de h√©roes aumentado a ${S.heroCap}.`); renderRoster(); };

$('#btn-gb-enter').onclick=()=>enterGlobalBoss();
$('#btn-gb-exit').onclick=()=>exitGlobalBoss();
$('#btn-gb-reset').onclick=()=>{ if (S.globalBoss && S.globalBoss.hp<=0){ S.globalBoss=createGlobalBoss(); log('‚ôªÔ∏è Boss Global recreado.'); updateGB(); } else { log('‚ÑπÔ∏è Solo si est√° derrotado.'); } };

// Hard reset confiable


const __hardBtn = document.getElementById('btn-hardreset');
function __doHardReset(){
  try{ localStorage.removeItem('tower_state_v1_13'); }catch(e){}
  try{ localStorage.removeItem('seeded_v1134'); }catch(e){}
  S={...DEFAULT};
  load();
  spawnEnemies(true);
  drawAll();
  teleReset();
  log('üßπ Guardado borrado. Seed inicial aplicado (25K oro + 1 h√©roe).');
}
if(__hardBtn){
  __hardBtn.onclick = __doHardReset;
  __hardBtn.addEventListener('click', __doHardReset);
}

if(__hardBtn){
  __hardBtn.onclick = __doHardReset;
  __hardBtn.addEventListener('click', __doHardReset);
}


/* ===== Loop ===== */
let lastT=performance.now();
function loop(){
  const t=performance.now(); const dt=Math.min(0.25,(t-lastT)/1000); lastT=t;
  if (!S.paused && battleActive){
    for(const id of S.party){
      const h=S.roster.find(x=>x.id===id); if(!h||h.hpBattle<=0) continue; const {st}=effectiveWithAuras(h);
      partyCD[id]=(partyCD[id] ?? (1/st.spd)) - dt; while (partyCD[id] <= 0 && enemies.some(e=>e.hp>0)){ heroAttack(h); partyCD[id] += 1/st.spd; }
    }
    for(const e of enemies){ if (e.hp<=0) continue; enemyCD[e.id]=(enemyCD[e.id] ?? (1/e.spd)) - dt; while (enemyCD[e.id] <= 0 && S.party.some(pid=>S.roster.find(h=>h.id===pid)?.hpBattle>0)){ enemyAttack(e); enemyCD[e.id] += 1/e.spd; } }
    priestHealing(dt);
  }
  $('#floor').textContent=S.floor; $('#wave').textContent=S.wave; $('#gold').textContent=nf(S.gold); $('#gems').textContent=nf(S.gems); $('#souls').textContent=S.soulStones||0;
  requestAnimationFrame(loop);
}

/* ===== Init ===== */
function drawAll(){ renderRoster(); if(!selectedHeroId && S.roster[0]){ selectedHeroId=S.roster[0].id; } const h=S.roster.find(x=>x.id===selectedHeroId); if(h) renderEquip(h); renderBattleHUD(); renderEnemiesHUD(); renderTree(); renderCheckpointSelect(); }
function init(){ load(); if(!S.globalBoss) S.globalBoss=createGlobalBoss(); spawnEnemies(true); drawAll(); teleReset(); setInterval(save, 3000); requestAnimationFrame(loop); updateGB();
  // SelfTest banner verde
  const okDiv=document.createElement('div'); okDiv.style.position='fixed'; okDiv.style.bottom='0'; okDiv.style.left='0'; okDiv.style.right='0'; okDiv.style.zIndex='9999'; okDiv.style.padding='6px'; okDiv.style.textAlign='center'; okDiv.style.fontWeight='bold'; okDiv.style.background='#2d6a4f'; okDiv.textContent='BUILD v1.13.5 FULL OK ‚Äî seed y features activas'; document.body.appendChild(okDiv); setTimeout(()=>okDiv.remove(),4000);
}
init();
})();
</script>
</body>
</html>
